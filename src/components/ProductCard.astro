---
import OptimizedImage from './OptimizedImage.astro';
import type { ProductImage, ProductImages } from '../data/products';

interface Props {
    id: string;
    name: string;
    price: number;
    originalPrice?: number;
    // Nueva estructura de imágenes
    productImages?: ProductImages;
    // Legacy: array de imágenes
    images?: ProductImage[] | string[];
    brand: string;
    presentation: string;
    tags?: string[];
    categories: string[];
}

const {
    id,
    name,
    price,
    originalPrice,
    productImages,
    images,
    brand,
    presentation,
    tags = [],
    categories = [],
} = Astro.props;

// Obtener imagen principal - priorizar nueva estructura
let image = "/placeholder.png";
let imageAlt = name;
let imageTitle = name;

if (productImages?.main) {
    // Nueva estructura
    image = productImages.main.src;
    imageAlt = productImages.main.alt;
    imageTitle = productImages.main.title || name;
} else if (images && images.length > 0) {
    // Formato legacy
    const firstImage = images[0];
    if (typeof firstImage === 'string') {
        image = firstImage;
    } else {
        image = firstImage.src;
        imageAlt = firstImage.alt || name;
        imageTitle = firstImage.title || name;
    }
}

const discount = originalPrice
    ? Math.round(((originalPrice - price) / originalPrice) * 100)
    : 0;

// Use the first category for the URL, default to 'producto' if none
const categorySlug = categories.length > 0 ? categories[0] : "producto";
const productUrl = `/${categorySlug}/${id}`;

// Helper for tag styles
const getTagStyle = (tag: string) => {
    const styles: Record<string, string> = {
        Orgánico: "from-green-500 to-emerald-700",
        Premium: "from-amber-400 to-orange-600",
        "Sin Azúcar": "from-blue-400 to-cyan-600",
        Keto: "from-purple-500 to-indigo-700",
        Gourmet: "from-rose-400 to-pink-600",
        Superfood: "from-teal-400 to-green-600",
        Cosmético: "from-fuchsia-400 to-purple-600",
        Vegano: "from-lime-400 to-green-600",
        Detox: "from-emerald-400 to-teal-600",
    };
    return styles[tag] || "from-gray-500 to-gray-700";
};
---

<div
    class="card bg-base-100 border-[3px] border-base-200 hover:border-primary/50 transition-all duration-300 group h-full flex flex-col rounded-2xl overflow-hidden relative"
>
    <!-- Discount Badge - Top Right -->
    {
        discount > 0 && (
            <div class="absolute top-4 right-0 z-10">
                <div class="bg-linear-to-r from-red-500 to-rose-600 text-white font-bold text-sm py-1 px-3 rounded-l-xl shadow-md flex items-center gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                        />
                    </svg>
                    -{discount}%
                </div>
            </div>
        )
    }

    <a href={productUrl} class="block relative pt-8 px-6 pb-2">
        <OptimizedImage
            src={image}
            alt={imageAlt}
            title={imageTitle}
            width={400}
            height={400}
            loading="lazy"
            class="h-52 w-full object-contain group-hover:scale-105 transition-transform duration-500"
        />
        
        <!-- Tags - Bottom Left of Image -->
        {tags.length > 0 && (
            <div class="absolute bottom-2 left-0 flex flex-col gap-1.5 items-start">
                {tags.map((tag) => (
                    <div
                        class={`bg-linear-to-r ${getTagStyle(tag)} text-white font-bold text-xs py-1 px-3 rounded-r-xl shadow-md flex items-center gap-1`}
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-3 w-3"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 13l4 4L19 7"
                            />
                        </svg>
                        {tag.toUpperCase()}
                    </div>
                ))}
            </div>
        )}
    </a>

    <div class="card-body p-5 flex-1 flex flex-col">
        <div
            class="text-xs text-base-content/50 font-bold uppercase mb-1 tracking-wider"
        >
            {brand}
        </div>

        <a href={productUrl} class="hover:text-primary transition-colors">
            <h2
                class="card-title text-lg font-extrabold leading-tight mb-1 line-clamp-2"
            >
                {name}
            </h2>
        </a>

        <!-- Presentation restored -->
        <div
            class="text-sm text-base-content/70 font-medium mb-4 bg-base-100 inline-block px-2 py-1 rounded-md self-start"
        >
            {presentation}
        </div>

        <div class="mt-auto w-full pt-2 border-t border-base-100">
            <div class="flex items-center gap-3 mb-4 mt-3">
                <span class="text-3xl font-black text-base-content">
                    S/ {price.toFixed(2)}
                </span>
                {
                    originalPrice && (
                        <span class="text-sm text-base-content/40 line-through decoration-2 font-semibold">
                            S/ {originalPrice.toFixed(2)}
                        </span>
                    )
                }
            </div>

            <button
                class="btn btn-primary btn-block rounded-xl font-bold text-lg hover:scale-[1.02] active:scale-95 transition-all add-to-cart shadow-lg shadow-primary/20"
                data-id={id}
                data-name={name}
                data-price={price}
                data-image={image}
                aria-label={`Agregar ${name} al carrito`}
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6 mr-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    aria-hidden="true"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                Agregar
            </button>
        </div>
    </div>
</div>

<script>
    import { addCartItem } from "../store/cart";
    import { playAddToCartSound } from "../utils/sound";

    const buttons = document.querySelectorAll(".add-to-cart");
    buttons.forEach((button) => {
        button.addEventListener("click", (e) => {
            e.preventDefault();

            playAddToCartSound();

            const btn = button as HTMLElement;
            const { id, name, price, image } = btn.dataset;

            addCartItem({
                id: id!,
                name: name!,
                price: Number(price),
                image: image!,
            });

            // Feedback animation
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
        ¡Agregado!
      `;
            btn.classList.add("btn-success", "text-white");

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove("btn-success", "text-white");
            }, 1500);
        });
    });
</script>
